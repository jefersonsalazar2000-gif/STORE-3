<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MEGA STORE 360 — Afiliados</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { inter: ['Inter','ui-sans-serif','system-ui'] },
          colors: {
            bg: '#0b0f1a',
            card: '#0f172a',
            stroke: '#6d28d9'
          },
          boxShadow: {
            'card': '0 0 0 2px rgba(109,40,217,0.6), 0 6px 24px rgba(0,0,0,0.35)'
          }
        }
      }
    }
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{ color-scheme: dark; }
    body { font-family: 'Inter', sans-serif; }
    .grad-btn{ background-image: linear-gradient(90deg,#07a0ff, #9b34ff, #ff2ea6); }
    .grad-input{ background-image: linear-gradient(90deg, rgba(7,160,255,.4), rgba(155,52,255,.4)); }
    .btn-ghost{ border:1px solid rgba(255,255,255,.15); }
    .line-2{
      display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden;
    }
  </style>

  <!-- Firebase (compat) opcional -->
  <script defer src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body class="bg-bg text-white min-h-screen">
  <!-- HEADER -->
  <header class="border-b border-white/10">
    <div class="max-w-7xl mx-auto px-4 py-4 flex items-center gap-3">
      <div class="h-9 w-9 rounded-full overflow-hidden ring-2 ring-white/15 shrink-0">
        <img src="https://i.imgur.com/9cZl8mQ.png" alt="J_A" class="w-full h-full object-cover">
      </div>
      <div class="flex-1">
        <h1 class="text-xl font-extrabold tracking-tight"><span class="text-[#4fc3ff]">MEGA STORE</span> <span class="text-white/80">360</span></h1>
        <p class="text-xs text-white/60">De todo • Tecnología • Hogar • Accesorios · <span class="hidden sm:inline">All • Technology • Home • Accessories</span></p>
      </div>
      <div class="flex items-center gap-2">
        <a id="btnYoutubeTop" target="_blank" rel="noopener" class="px-3 py-1.5 rounded-lg btn-ghost text-sm">YouTube</a>
        <button id="btnAdminTop" class="px-3 py-1.5 rounded-lg btn-ghost text-sm">Admin</button>
      </div>
    </div>
  </header>

  <!-- BARRA DE BUSQUEDA + CONTROLES -->
  <section class="max-w-7xl mx-auto px-4 pt-6">
    <div class="flex flex-col lg:flex-row gap-3 items-stretch">
      <div class="flex-1">
        <div class="rounded-2xl grad-input p-[1.5px]">
          <div class="rounded-2xl bg-bg/80 px-4 py-3 flex items-center gap-3">
            <svg width="18" height="18" viewBox="0 0 24 24" class="opacity-70"><path fill="currentColor" d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16a6.471 6.471 0 0 0 4.23-1.57l.27.28v.79l5 4.99L20.49 19zM4 9.5A5.5 5.5 0 1 1 9.5 15 5.507 5.507 0 0 1 4 9.5"/></svg>
            <input id="searchInput" class="bg-transparent outline-none w-full placeholder:text-white/50" placeholder="Buscar productos… (ej. iPhone, smartwatch)" />
            <button id="clearSearch" class="text-sm text-white/70 hover:text-white">Limpiar</button>
          </div>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <select id="catSelect" class="rounded-xl bg-[#0f172a] border border-white/15 px-3 py-2 text-sm">
          <option value="all">Todas las categorías</option>
          <option>Tecnología</option>
          <option>Hogar</option>
          <option>Fitness</option>
          <option>Mascotas</option>
          <option>Gaming</option>
          <option>Otros</option>
        </select>
        <button id="btnAdd" class="hidden px-4 py-2 rounded-xl grad-btn text-sm font-semibold">+ Agregar • Add</button>
      </div>
    </div>
  </section>

  <!-- GRID -->
  <main class="max-w-7xl mx-auto px-4 py-6">
    <div id="grid" class="grid sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5"></div>
    <p id="empty" class="hidden text-center text-white/60 mt-8">No hay resultados.</p>
  </main>

  <!-- FOOTER -->
  <footer class="border-t border-white/10 text-sm text-white/60">
    <div class="max-w-7xl mx-auto px-4 py-6">
      © <span id="year"></span> MEGA STORE 360 — Amazon Afiliados
    </div>
  </footer>

  <!-- MODAL -->
  <dialog id="dlg" class="rounded-2xl p-0 w-[min(680px,96vw)] bg-[#0f172a] border border-white/10">
    <form method="dialog" id="productForm">
      <div class="p-4 border-b border-white/10 flex items-center justify-between">
        <h3 class="font-bold">Producto</h3>
        <button id="dlgClose" class="px-3 py-1.5 rounded-lg btn-ghost">Cancelar</button>
      </div>
      <div class="p-4 grid sm:grid-cols-2 gap-4">
        <div class="sm:col-span-2">
          <label class="text-sm text-white/70">Título</label>
          <input id="fTitle" required class="w-full rounded-lg bg-white/5 border border-white/10 px-3 py-2">
        </div>
        <div>
          <label class="text-sm text-white/70">Categoría</label>
          <input id="fCat" list="cats" required class="w-full rounded-lg bg-white/5 border border-white/10 px-3 py-2">
          <datalist id="cats">
            <option>Tecnología</option><option>Hogar</option><option>Fitness</option><option>Mascotas</option><option>Gaming</option><option>Otros</option>
          </datalist>
        </div>
        <div>
          <label class="text-sm text-white/70">Precio (opcional)</label>
          <input id="fPrice" type="number" step="0.01" min="0" class="w-full rounded-lg bg-white/5 border border-white/10 px-3 py-2">
        </div>
        <div class="sm:col-span-2">
          <label class="text-sm text-white/70">Imagen (URL)</label>
          <input id="fImg" required class="w-full rounded-lg bg-white/5 border border-white/10 px-3 py-2" placeholder="https://...">
        </div>
        <div class="sm:col-span-2">
          <label class="text-sm text-white/70">URL Amazon</label>
          <input id="fUrl" required class="w-full rounded-lg bg-white/5 border border-white/10 px-3 py-2" placeholder="https://www.amazon.com/dp/ASIN...">
          <p class="text-xs text-white/50 mt-1">Se añadirá tu tag afiliado automáticamente.</p>
        </div>
        <input id="fId" type="hidden">
      </div>
      <div class="p-4 border-t border-white/10 flex justify-end">
        <button class="px-4 py-2 rounded-xl grad-btn font-semibold">Guardar</button>
      </div>
    </form>
  </dialog>

  <!-- SCRIPTS -->
  <script>
  // ===== CONFIG =====
  const AMAZON_TAG = "kaninosabioan-20";
  const YOUTUBE_URL = "https://www.youtube.com/@SABIDURIAANIMAL86";
  const firebaseConfig = null; // <-- pega aquí tu config para sincronizar (si lo dejas null, usa demo/localStorage)

  // ===== UTIL =====
  const $ = (s, r=document) => r.querySelector(s);
  const $$ = (s, r=document) => [...r.querySelectorAll(s)];
  $("#year").textContent = new Date().getFullYear();
  $("#btnYoutubeTop").href = YOUTUBE_URL;

  // Estado
  let ADMIN=false, PRODUCTS=[], FILTER={text:"", cat:"all"};
  let db=null, auth=null, usingDemo=true;

  // DEMO
  const DEMO = [
    {title:"Máquina de café espresso, acero inoxidable cepillado", cat:"Hogar / Home", price:799.95, img:"https://images.unsplash.com/photo-1512568400610-62da28bc8a13?q=80&w=1200&auto=format&fit=crop", url:"https://www.amazon.com/dp/B0COFFEE01"},
    {title:"Removedor de pelo para tu mascota • Hair Remover For Your Pet", cat:"Otros / Other", price:7.99, img:"https://images.unsplash.com/photo-1548199973-03cce0bbc87b?q=80&w=1200&auto=format&fit=crop", url:"https://www.amazon.com/dp/B0PETS001"},
    {title:"NORTIV 8 — Zapatos deportivos para correr y caminar", cat:"Tecnología / Technology", price:46.38, img:"https://images.unsplash.com/photo-1542291026-7eec264c27ff?q=80&w=1200&auto=format&fit=crop", url:"https://www.amazon.com/dp/B0SHOES01"},
    {title:"Logo de Amazon Prime Disfruta de entrega rápida y gratis, ofertas…", cat:"Tecnología / Technology", price:149.00, img:"https://images.unsplash.com/photo-1612211264770-8f3c37306a7e?q=80&w=1200&auto=format&fit=crop", url:"https://www.amazon.com/dp/B0PRIME01"},
  ];

  // ===== ARRANQUE =====
  window.addEventListener('load', init);
  async function init(){
    // Admin
    $("#btnAdminTop").addEventListener('click', ()=>{
      const pin = prompt("PIN admin (360):","");
      ADMIN = pin==="360";
      alert(ADMIN? "Modo Admin activado":"PIN incorrecto");
      render();
    });

    // Controles
    $("#catSelect").addEventListener('change', e=>{ FILTER.cat = e.target.value; render(); });
    $("#searchInput").addEventListener('input', e=>{ FILTER.text = e.target.value; render(); });
    $("#clearSearch").addEventListener('click', ()=>{ $("#searchInput").value=""; FILTER.text=""; render(); });

    // Modal close
    const dlg = $("#dlg");
    $("#dlgClose").addEventListener('click', e=>{ e.preventDefault(); dlg.close(); });
    document.addEventListener('keydown', e=>{ if(e.key==='Escape' && dlg.open) dlg.close(); });
    dlg.addEventListener('click', e=>{
      const r = dlg.getBoundingClientRect();
      const outside = e.clientX < r.left || e.clientX > r.right || e.clientY < r.top || e.clientY > r.bottom;
      if (outside) dlg.close();
    });

    // Botón agregar
    $("#btnAdd").addEventListener('click', ()=>{
      $("#fId").value=""; $("#fTitle").value=""; $("#fCat").value="Tecnología";
      $("#fPrice").value=""; $("#fImg").value=""; $("#fUrl").value="";
      dlg.showModal();
    });

    // Guardar
    $("#productForm").addEventListener('submit', async (e)=>{
      e.preventDefault();
      const data = {
        id: $("#fId").value || null,
        title: $("#fTitle").value.trim(),
        cat: $("#fCat").value.trim(),
        price: $("#fPrice").value ? Number($("#fPrice").value) : null,
        img: $("#fImg").value.trim(),
        url: $("#fUrl").value.trim()
      };
      if (!data.title || !data.cat || !data.img || !data.url) { alert("Completa todos los campos obligatorios."); return; }
      await saveProduct(data);
      await loadProducts();
      render();
      dlg.close();
    });

    // Firebase opcional
    try{
      if (firebaseConfig && typeof firebase!=='undefined'){
        firebase.initializeApp(firebaseConfig);
        auth = firebase.auth();
        db   = firebase.firestore();
        await auth.signInAnonymously();
        usingDemo=false;
      }
    }catch(err){
      console.warn("Firebase no disponible, usando DEMO/localStorage.", err);
      usingDemo=true;
    }

    await loadProducts();
    render();
  }

  // ===== CRUD =====
  async function loadProducts(){
    if (!usingDemo && db){
      const snap = await db.collection('products').orderBy('createdAt','desc').get();
      PRODUCTS = snap.docs.map(d=>({id:d.id, ...d.data()}));
      if (!PRODUCTS.length){
        // sembrar demo 1 vez
        const batch = db.batch();
        DEMO.forEach(p=>{
          const ref = db.collection('products').doc();
          batch.set(ref, {...p, createdAt: firebase.firestore.FieldValue.serverTimestamp()});
        });
        await batch.commit();
        return loadProducts();
      }
    }else{
      // localStorage como fallback
      const raw = localStorage.getItem('productsV2');
      PRODUCTS = raw ? JSON.parse(raw) : DEMO.map((p,i)=>({id:'demo-'+i, ...p}));
      localStorage.setItem('productsV2', JSON.stringify(PRODUCTS));
    }
  }

  async function saveProduct(p){
    p.url = withAffiliate(p.url);
    if (!usingDemo && db){
      if (p.id){ const {id, ...rest}=p; await db.collection('products').doc(id).set(rest,{merge:true}); }
      else { await db.collection('products').add({...p, createdAt: firebase.firestore.FieldValue.serverTimestamp()}); }
    }else{
      if (p.id){ PRODUCTS = PRODUCTS.map(x=> x.id===p.id ? p : x); }
      else { p.id='ls-'+Date.now(); PRODUCTS.unshift(p); }
      localStorage.setItem('productsV2', JSON.stringify(PRODUCTS));
    }
  }

  async function deleteProduct(id){
    if (!id) return;
    if (!usingDemo && db){ await db.collection('products').doc(id).delete(); }
    else { PRODUCTS = PRODUCTS.filter(x=>x.id!==id); localStorage.setItem('productsV2', JSON.stringify(PRODUCTS)); }
    await loadProducts(); render();
  }

  // ===== RENDER =====
  function withAffiliate(url){
    try{ const u=new URL(url); if(!u.searchParams.has('tag')) u.searchParams.set('tag', AMAZON_TAG); return u.toString(); }
    catch{return url}
  }

  function filtered(){
    const t = FILTER.text.trim().toLowerCase();
    const c = FILTER.cat.toLowerCase();
    return PRODUCTS.filter(p=>{
      const okCat = c==='all' || (p.cat||'').toLowerCase().includes(c);
      const okTxt = !t || (p.title||'').toLowerCase().includes(t) || (p.cat||'').toLowerCase().includes(t);
      return okCat && okTxt;
    });
  }

  function card(p){
    const price = p.price!=null ? `$${Number(p.price).toFixed(2)}` : '';
    const url = withAffiliate(p.url||'#');
    return `
      <article class="rounded-2xl bg-[#0f172a] shadow-card border border-stroke/40 overflow-hidden">
        <div class="p-3">
          <div class="rounded-xl overflow-hidden aspect-[4/3] bg-black/20">
            <img src="${p.img}" alt="" class="w-full h-full object-cover">
          </div>
        </div>
        <div class="px-4 pb-4">
          <h3 class="font-semibold leading-snug line-2">${escapeHtml(p.title||'')}</h3>
          <div class="text-xs text-white/60 mt-1">${escapeHtml(p.cat||'')}</div>
          <div class="mt-2 font-semibold">${price}</div>

          <div class="mt-3 rounded-xl bg-[#0b1120] p-3 border border-white/10">
            <div class="grid grid-cols-2 gap-2">
              <a href="${url}" target="_blank" rel="nofollow sponsored noopener" class="grad-btn text-center font-semibold rounded-lg py-2">Ver en Amazon</a>
              <a href="${url}" target="_blank" rel="nofollow sponsored noopener" class="grad-btn text-center font-semibold rounded-lg py-2">View on Amazon</a>
            </div>
            <div class="flex items-center gap-2 mt-2 text-xs text-white/60">
              <span class="inline-flex w-5 h-5 items-center justify-center rounded-full bg-white/10">?</span>
              <span>Compra segura con tu enlace de afiliado</span>
            </div>
          </div>

          ${ADMIN ? `
            <div class="mt-3 flex gap-2">
              <button data-edit="${p.id}" class="px-3 py-1.5 rounded-lg btn-ghost text-sm">Editar</button>
              <button data-del="${p.id}" class="px-3 py-1.5 rounded-lg btn-ghost text-sm">Eliminar</button>
            </div>
          `:''}
        </div>
      </article>
    `;
  }

  function render(){
    $("#btnAdd").classList.toggle('hidden', !ADMIN);
    const list = filtered();
    $("#grid").innerHTML = list.map(card).join('');
    $("#empty").classList.toggle('hidden', list.length>0);

    if (ADMIN){
      $$('[data-edit]').forEach(b=>{
        b.onclick = ()=>{
          const id = b.getAttribute('data-edit');
          const p = PRODUCTS.find(x=>x.id===id);
          if(!p) return;
          $("#fId").value=p.id; $("#fTitle").value=p.title||''; $("#fCat").value=p.cat||'';
          $("#fPrice").value=p.price||''; $("#fImg").value=p.img||''; $("#fUrl").value=p.url||'';
          $("#dlg").showModal();
        }
      });
      $$('[data-del]').forEach(b=>{
        b.onclick = async ()=>{
          const id = b.getAttribute('data-del');
          if(confirm('¿Eliminar este producto?')){ await deleteProduct(id); }
        }
      });
    }
  }

  // ===== HELPERS =====
  function escapeHtml(s=""){ return s.replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m])); }
  </script>
</body>
</html>
