<!DOCTYPE html>
<html lang="es" class="h-full bg-[#0b0f1a]">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>J_A MEGA STORE 360</title>
  <meta name="theme-color" content="#0b0f1a"/>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json?v=6" />
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192x192-v6.png?v=6">
  <link rel="apple-touch-icon" href="icon-180x180-v6.png?v=6">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { outfit: ['Outfit','ui-sans-serif','system-ui']},
          colors: { base:'#0b0f1a', card:'#12172a', soft:'#1a2140' }
        }
      }
    }
  </script>

  <!-- Fuente -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800;900&display=swap" rel="stylesheet">

  <!-- Config auto (opcional: puedes rellenarlo aquí y se aplica en todas las sesiones) -->
  <script>
    window.AUTO_FIREBASE_CONFIG = {
      /* Ejemplo si quieres fijarlo aquí en duro (sino, usa firebaseConfig.json o Ajustes):
      apiKey: "AIzaSyD04Eu_MW_RSzJaZt9DsFhvA9FefmioPzQ",
      authDomain: "mega-store-360.firebaseapp.com",
      projectId: "mega-store-360",
      storageBucket: "mega-store-360.appspot.com",
      messagingSenderId: "515110738243",
      appId: "1:515110738243:web:84ebd48215c295647eb7f6",
      measurementId: "G-KRR7B05HL9"
      */
    };
  </script>

  <style>
    :root{
      --grad-1: linear-gradient(135deg,#00E5FF 0%, #7C3AED 50%, #FF0099 100%);
      --btn-grad: linear-gradient(135deg, #00E5FF 0%, #7C3AED 50%, #FF0099 100%);
      --ring: 0 0 0 1.5px rgba(124,58,237,.45), 0 0 18px rgba(124,58,237,.35), inset 0 0 12px rgba(0,229,255,.25);
    }
    body{ font-family:'Outfit',sans-serif }
    .neon-title{ background:var(--grad-1); -webkit-background-clip:text; background-clip:text; color:transparent; text-shadow:0 0 18px rgba(124,58,237,.25) }
    .btn-neon{ background:var(--btn-grad); color:#0b0f1a; font-weight:800; box-shadow:0 0 24px rgba(124,58,237,.35); transition:transform .12s, box-shadow .12s }
    .btn-neon:hover{ transform:translateY(-1px) scale(1.005); box-shadow:0 0 32px rgba(124,58,237,.55) }
    .chip{ background:rgba(124,58,237,.15); border:1px solid rgba(124,58,237,.35) }
    .card{ background:radial-gradient(1200px 500px at -10% -10%, rgba(124,58,237,.12), transparent 50%), radial-gradient(1000px 400px at 120% 120%, rgba(0,229,255,.10), transparent 45%), #12172a; border:1px solid rgba(124,58,237,.25) }
    .toolbar{ background:linear-gradient(180deg, rgba(18,23,42,.85), rgba(18,23,42,.6) 60%, rgba(18,23,42,.1)); border-bottom:1px solid rgba(124,58,237,.25); backdrop-filter:blur(8px) }
    .gradient-border{ position:relative; border-radius:16px; overflow:hidden }
    .gradient-border::before{ content:''; position:absolute; inset:0; padding:1px; border-radius:16px; background:var(--grad-1);
      -webkit-mask:linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0); -webkit-mask-composite:xor; mask-composite:exclude; pointer-events:none }
    .input{ background:#0e1430; border:1px solid rgba(124,58,237,.35); outline:none; color:white; border-radius:12px; padding:.7rem .9rem }
    .input:focus{ box-shadow:var(--ring) }
    .tag{ background:rgba(10,239,255,.12); border:1px solid rgba(10,239,255,.35) }
    html, body { max-width:100%; overflow-x:hidden; }
    body { touch-action: pan-y; overscroll-behavior-x: none; }
    .admin-only{ display:none !important; }
    .is-admin .admin-only{ display:inline-flex !important; }
    /* Ocultar FAB “Destacados” si lo deseas */
    /* #fabDestacados { display:none !important } */
  </style>
</head>

<body class="min-h-full text-white bg-[radial-gradient(1200px_600px_at_20%_-10%,rgba(124,58,237,.15),transparent_55%),radial-gradient(900px_500px_at_120%_10%,rgba(0,229,255,.12),transparent_50%),#0b0f1a]">

  <!-- Header -->
  <header class="toolbar sticky top-0 z-30">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3">
      <div id="brandTrigger" class="w-10 h-10 rounded-xl gradient-border flex items-center justify-center shrink-0">
        <div class="w-full h-full rounded-[14px] bg-[#0e1430] flex items-center justify-center">
          <span class="text-xl font-extrabold">J_A</span>
        </div>
      </div>
      <div class="flex-1">
        <h1 class="text-xl sm:text-2xl font-extrabold neon-title leading-none">MEGA STORE 360</h1>
        <p class="text-xs text-white/70 -mt-0.5">De todo • Tecnología • Hogar • Accesorios</p>
      </div>
      <a href="http://www.youtube.com/@SABIDURIAANIMAL86" target="_blank" class="px-3 py-2 rounded-xl chip text-sm font-semibold hover:opacity-90">YouTube</a>

      <div class="flex items-center gap-2">
        <button id="btnSettings" class="px-3 py-2 rounded-xl chip text-sm font-semibold hover:opacity-90">Ajustes</button>
        <button id="btnAdmin" class="px-3 py-2 rounded-xl chip text-sm font-semibold hover:opacity-90">Admin</button>
        <button id="btnVerify" class="px-3 py-2 rounded-xl chip text-sm font-semibold hover:opacity-90 hidden">Verificar Tag</button>
        <button id="btnFix" class="px-3 py-2 rounded-xl chip text-sm font-semibold hover:opacity-90 hidden">Auto-Fix Tag</button>
        <button id="btnDestacadosHeader" class="px-3 py-2 rounded-xl chip text-sm font-semibold hover:opacity-90">★ Destacados</button>
      </div>
    </div>
  </header>

  <!-- Controles -->
  <section class="max-w-7xl mx-auto px-4 mt-4 grid gap-3 sm:grid-cols-[1fr_auto_auto]">
    <div class="gradient-border">
      <input id="search" class="input w-full" placeholder="Buscar productos… (ej. iPhone, smartwatch)" />
    </div>
    <select id="categoryFilter" class="input">
      <option value="all">Todas las categorías</option>
    </select>
    <button id="btnAdd" class="btn-neon px-4 py-2 rounded-xl text-sm disabled:opacity-40" disabled>+ Agregar</button>
  </section>

  <!-- Grid -->
  <main class="max-w-7xl mx-auto px-4 py-6">
    <div id="grid" class="grid gap-4 grid-cols-2 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4"></div>
    <p id="empty" class="hidden text-center text-white/60 mt-10">No hay productos que coincidan.</p>
  </main>

  <!-- Footer -->
  <footer class="border-t border-white/10 py-8">
    <div class="max-w-7xl mx-auto px-4 text-sm text-white/60">
      <div class="flex flex-wrap items-center gap-2">
        <span class="font-semibold">Aviso Amazon Afiliados:</span>
        <span>Como afiliado de Amazon, puedo ganar comisiones por compras calificadas.</span>
      </div>
      <div class="mt-2">© <span id="year"></span> J_A MEGA STORE 360 — Todos los derechos reservados.</div>
    </div>
  </footer>

  <!-- Modal CRUD -->
  <dialog id="modal" class="backdrop:bg-black/70 rounded-2xl w-[min(720px,92vw)]">
    <form id="form" method="dialog" class="card rounded-2xl p-4 sm:p-6">
      <div class="flex items-center justify-between mb-4">
        <h3 id="modalTitle" class="text-lg font-extrabold neon-title">Nuevo producto</h3>
        <button type="button" class="chip px-3 py-1.5 rounded-xl" onclick="modal.close()">Cerrar</button>
      </div>

      <div class="grid gap-3 sm:grid-cols-2">
        <div class="gradient-border"><input required id="pTitle" class="input w-full" placeholder="Título / Nombre" /></div>
        <div class="gradient-border"><input id="pBrand" class="input w-full" placeholder="Marca (opcional)" /></div>

        <div class="sm:col-span-2 grid gap-2">
          <div class="gradient-border"><input id="pImageUrl" class="input w-full" placeholder="URL de imagen (https://… Amazon u otro)" /></div>
          <div class="text-xs text-white/60">o sube un archivo (se guarda en Nube si está conectada, o local en este dispositivo)</div>
          <input id="pImageFile" type="file" accept="image/*" class="block text-sm" />
        </div>

        <div class="gradient-border sm:col-span-2"><input required id="pAmazon" class="input w-full" placeholder="URL de Amazon (con o sin ?tag=)" /></div>

        <div class="gradient-border"><input id="pPrice" class="input w-full" placeholder="Precio (opcional, ej. 799.00)" inputmode="decimal" /></div>
        <div class="gradient-border">
          <select id="pCategory" class="input w-full">
            <option>Tecnología</option><option>Teléfonos</option><option>Accesorios</option>
            <option>Hogar</option><option>Gaming</option><option>Gym</option>
            <option>Salud</option><option>Animales</option><option>Los más buscados</option><option>Otros</option>
          </select>
        </div>
      </div>

      <div class="mt-4 flex items-center justify-between">
        <label class="flex items-center gap-2 text-sm text-white/80">
          <input id="pFeatured" type="checkbox" class="accent-fuchsia-500 scale-110" />
          Destacado
        </label>
        <div class="flex items-center gap-2">
          <button type="button" id="btnDelete" class="px-3 py-2 rounded-xl chip text-sm hidden">Eliminar</button>
          <button type="submit" class="btn-neon px-4 py-2 rounded-xl">Guardar</button>
        </div>
      </div>
    </form>
  </dialog>

  <!-- Modal Ajustes / Conectar Nube -->
  <dialog id="settings" class="backdrop:bg-black/70 rounded-2xl w-[min(720px,92vw)]">
    <form method="dialog" class="card rounded-2xl p-4 sm:p-6">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-extrabold neon-title">Ajustes</h3>
        <button type="submit" class="chip px-3 py-1.5 rounded-xl text-sm">Cerrar</button>
      </div>

      <div class="grid gap-3">
        <div class="gradient-border p-3 rounded-xl">
          <label class="text-sm text-white/80 font-semibold">Clave Admin</label>
          <input id="adminKeyInput" class="input w/full mt-2" placeholder="Escribe tu clave para activar Admin" />
          <p class="text-xs text-white/60 mt-1">Actual: <span id="adminKeyLabel">mega360</span></p>
          <button id="saveAdminKey" type="button" class="mt-2 chip px-3 py-1.5 rounded-xl text-sm">Guardar clave</button>
        </div>

        <div class="gradient-border p-3 rounded-xl">
          <label class="text-sm text-white/80 font-semibold">Config Nube (pega tu firebaseConfig JSON aquí)</label>
          <textarea id="firebaseConfigInput" class="input w/full h-40 mt-2" placeholder='{"apiKey":"...","authDomain":"...","projectId":"...","storageBucket":"...","messagingSenderId":"...","appId":"..."}'></textarea>
          <div class="flex flex-wrap gap-2 mt-2">
            <button id="btnConnectCloud" type="button" class="chip px-3 py-1.5 rounded-xl text-sm">Conectar nube</button>
            <button id="btnDisconnectCloud" type="button" class="chip px-3 py-1.5 rounded-xl text-sm">Desconectar</button>
            <button id="btnHardReset" type="button" class="chip px-3 py-1.5 rounded-xl text-sm" onclick="resetStore(true)">Resetear caché y recargar</button>
          </div>
          <p class="text-xs text-white/60 mt-2" id="cloudStatus">Estado: Local</p>
        </div>
      </div>
    </form>
  </dialog>

  <!-- === APP (productos, nube, destacados) === -->
  <script type="module">
    let ADMIN_KEY = localStorage.getItem('ja_admin_key') || "mega360";
    const AFFILIATE_TAG_DEFAULT = "kaninosabioan-20";
    const LS_FEATURED = 'ja_featured_ids_v1';

    let isAdmin = false;
    let editingId = null;
    let products = [];
    let db = null, unsub = null, storage = null;
    let cloudConfig = null;

    const grid = document.getElementById('grid');
    const empty = document.getElementById('empty');
    const search = document.getElementById('search');
    const categoryFilter = document.getElementById('categoryFilter');
    const btnAdd = document.getElementById('btnAdd');
    const btnAdmin = document.getElementById('btnAdmin');
    const btnSettings = document.getElementById('btnSettings');
    const year = document.getElementById('year');

    const modal = document.getElementById('modal');
    const form = document.getElementById('form');
    const modalTitle = document.getElementById('modalTitle');
    const pTitle = document.getElementById('pTitle');
    const pBrand = document.getElementById('pBrand');
    const pImageUrl = document.getElementById('pImageUrl');
    const pImageFile = document.getElementById('pImageFile');
    const pAmazon = document.getElementById('pAmazon');
    const pPrice = document.getElementById('pPrice');
    const pCategory = document.getElementById('pCategory');
    const pFeatured = document.getElementById('pFeatured');
    const btnDelete = document.getElementById('btnDelete');

    const settings = document.getElementById('settings');
    const adminKeyInput = document.getElementById('adminKeyInput');
    const adminKeyLabel = document.getElementById('adminKeyLabel');
    const saveAdminKey = document.getElementById('saveAdminKey');
    const firebaseConfigInput = document.getElementById('firebaseConfigInput');
    const cloudStatus = document.getElementById('cloudStatus');
    const btnConnectCloud = document.getElementById('btnConnectCloud');
    const btnDisconnectCloud = document.getElementById('btnDisconnectCloud');

    const btnVerify = document.getElementById('btnVerify');
    const btnFix = document.getElementById('btnFix');

    year.textContent = new Date().getFullYear();
    const uid = () => crypto.randomUUID();

    const feat = {
      get(){ try{return JSON.parse(localStorage.getItem(LS_FEATURED))||[]}catch{return[]} },
      set(v){ localStorage.setItem(LS_FEATURED, JSON.stringify(v||[])) },
      has(id){ return feat.get().includes(id) },
      add(id){ const s=new Set(feat.get()); s.add(id); feat.set([...s]) },
      del(id){ feat.set(feat.get().filter(x=>x!==id)) },
      toggle(id){ feat.has(id)?feat.del(id):feat.add(id) }
    };
    function syncFeaturedLSFromProducts(){
      try{
        const ids = (products||[]).filter(p=>!!p.featured && !!p.id).map(p=>p.id);
        feat.set(ids);
      }catch{}
    }

    function ensureTag(url){
      if(!url) return "#";
      if(/[?&]tag=/.test(url)) return url;
      const sep = url.includes('?') ? '&' : '?';
      return `${url}${sep}tag=${AFFILIATE_TAG_DEFAULT}`;
    }

    function productCard(p){
      const price = p.price?`$${Number(p.price).toLocaleString()}`:'';
      const tag = feat.has(p.id)?`<span class="tag text-xs px-2 py-1 rounded-lg font-semibold">Destacado</span>`:'';
      const brand = p.brand?`<span class="text-xs text-white/60">${p.brand}</span>`:'';
      const starBtn = `
        <button class="admin-only absolute top-2 right-2 px-2.5 py-1.5 rounded-lg border border-white/20 bg-white/10 text-white text-sm"
                data-star="${p.id}" aria-pressed="${feat.has(p.id)?'true':'false'}" title="Alternar Destacado">
          ${feat.has(p.id)?'★':'☆'}
        </button>`;
      const adminBtns = isAdmin ? `
        <div class="flex gap-2 mt-3 admin-only">
          <button class="chip px-3 py-1.5 rounded-xl text-sm" onclick="editProduct('${p.id}')">Editar</button>
          <button class="chip px-3 py-1.5 rounded-xl text-sm" onclick="removeProduct('${p.id}')">Eliminar</button>
        </div>` : '';
      return `
        <article class="card rounded-2xl p-3 sm:p-4 flex flex-col gradient-border relative">
          ${starBtn}
          <div class="rounded-xl overflow-hidden bg-soft aspect-[4/3]">
            <img src="${p.image}${p.image?.includes('?')?'&':'?'}v=10"
                 alt="${p.title}" class="w-full h-full object-cover" loading="lazy"
                 onerror="this.onerror=null;this.src='https://via.placeholder.com/800x600?text=Imagen';" />
          </div>
          <div class="mt-3 flex items-start justify-between gap-3">
            <div class="min-w-0">
              <h3 class="font-extrabold leading-tight line-clamp-2">${p.title}</h3>
              <div class="flex items-center gap-2 mt-1">${brand}${brand?'<span class="text-white/20">•</span>':''}<span class="text-xs text-white/60">${p.category}</span>${feat.has(p.id)?'<span class="text-white/20">•</span>'+tag:''}</div>
              ${price?`<div class="mt-1 text-white/90 font-semibold">${price}</div>`:''}
            </div>
          </div>
          <div class="mt-3">
            <a href="${ensureTag(p.amazon)}" target="_blank" rel="nofollow sponsored noopener" class="btn-neon w/full justify-center px-4 py-2 rounded-xl inline-flex items-center gap-2">
              Ver en Amazon
            </a>
            ${adminBtns}
          </div>
        </article>`;
    }

    function renderCategories(list){
      const cats = ['all', ...new Set(list.map(p=>p.category))];
      categoryFilter.innerHTML = cats.map(c => `<option value="${c}">${c==='all'?'Todas las categorías':c}</option>`).join('');
    }

    function applyFilters(){
      const term = (search.value||'').toLowerCase().trim();
      const cat = categoryFilter.value||'all';
      const filtered = products.filter(p=>{
        const t = !term || p.title.toLowerCase().includes(term) || (p.brand||'').toLowerCase().includes(term);
        const c = cat==='all' || p.category===cat;
        return t && c;
      });
      grid.innerHTML = filtered.map(productCard).join('');
      empty.classList.toggle('hidden', filtered.length>0);

      // listeners del botón ★
      grid.querySelectorAll('[data-star]').forEach(btn=>{
        btn.addEventListener('click', async (e)=>{
          e.stopPropagation();
          if(!isAdmin){ alert('Solo Admin'); return; }
          const id = btn.getAttribute('data-star');
          const newVal = !(btn.getAttribute('aria-pressed')==='true');
          await window.setFeatured(id, newVal);
        }, {passive:false});
      });
    }

    const LS_KEY = 'ja_store_products_v2';
    function local_load(){ try{ return JSON.parse(localStorage.getItem(LS_KEY))||[] }catch{ return [] } }
    function local_save(list){ localStorage.setItem(LS_KEY, JSON.stringify(list)) }

    async function fileToDataURL(file){
      if(!file) return null;
      return new Promise((res,rej)=>{
        const r=new FileReader();
        r.onload=()=>res(r.result);
        r.onerror=rej;
        r.readAsDataURL(file);
      });
    }

    /* ================== FIREBASE (NUBE) ================== */
    async function cloud_init(config){
      const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js');
      const { getFirestore, collection, onSnapshot, query, orderBy, doc, setDoc, serverTimestamp } =
        await import('https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js');
      const { getStorage, ref, uploadBytes, getDownloadURL } =
        await import('https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js');

      // Fix bucket si viene mal del usuario
      if (config && config.projectId && !config.storageBucket) {
        config.storageBucket = `${config.projectId}.appspot.com`;
      }

      const app = initializeApp(config);
      db = getFirestore(app);
      storage = getStorage(app);

      const q = query(collection(db,'products'), orderBy('createdAt','desc'));
      if(unsub) unsub();
      unsub = onSnapshot(q, snap=>{
        const remoteFeat = new Set();
        const remoteDocs = [];
        snap.forEach(d=>{
          const obj = d.data();
          if (obj && obj.id) {
            remoteDocs.push(obj);
            if (obj.featured === true) remoteFeat.add(obj.id);
          }
        });

        const base = local_load();
        const map = new Map(base.map(p=>[p.id,p]));
        for (const doc of remoteDocs){ if(doc && doc.id && !map.has(doc.id)) map.set(doc.id, doc); }

        // Si veníamos de un fallo de escritura, NO pises el estado local una vez
        const skip = !!window.__ms360_skipRemoteOnce;
        if (!skip) {
          products = Array.from(map.values()).map(p => ({ ...p, featured: remoteFeat.has(p.id) }));
        } else {
          products = Array.from(map.values());
          window.__ms360_skipRemoteOnce = false;
        }

        local_save(products);
        syncFeaturedLSFromProducts();
        renderCategories(products); applyFilters();
        window.dispatchEvent(new Event('ja_products_updated'));
      });

      window.cloud_delete = async (id)=>{
        const { deleteDoc, doc } = await import('https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js');
        await deleteDoc(doc(db,'products',id));
      };
      window.cloud_save = async (id, data)=>{
        await setDoc(doc(db,'products',id), { id, createdAt: serverTimestamp(), ...data }, { merge:true });
      };
      window.cloud_upload = async (file)=>{
        const fileName = `${Date.now()}_${file.name.replace(/\s+/g,'_')}`;
        const fileRef = ref(storage, `products/${fileName}`);
        await uploadBytes(fileRef,file);
        return await getDownloadURL(fileRef);
      };
      window.cloud_updateFeatured = async (id, value)=>{
        await setDoc(doc(db,'products',id), { id, featured: !!value, updatedAt: serverTimestamp() }, { merge:true });
      };
    }

    // === Toggle Destacado (nube + local, con “paracaídas” si falla) ===
    window.setFeatured = async function(id, value){
      try {
        if (db) await window.cloud_updateFeatured(id, value);
      } catch (e) {
        console.warn('Cloud write failed, keeping local for now:', e);
        window.__ms360_skipRemoteOnce = true;   // evita que el snapshot lo pise una vez
        alert('⚠️ No se pudo guardar en la nube.\nRevisa Reglas de Firestore o Configuración.\nSe aplicará localmente por ahora.');
      }
      products = (products||[]).map(p => p.id===id ? ({...p, featured: !!value}) : p);
      local_save(products);
      syncFeaturedLSFromProducts();
      applyFilters();
      if (typeof window.__renderFeaturedIfOpen === 'function') window.__renderFeaturedIfOpen();
    }

    // === CRUD ===
    window.editProduct = (id)=>{
      const p = products.find(x=>x.id===id); if(!p) return;
      editingId = id;
      modalTitle.textContent = "Editar producto";
      pTitle.value = p.title||'';
      pBrand.value = p.brand||'';
      pImageUrl.value = p.image||'';
      pImageFile.value = "";
      pAmazon.value = p.amazon||'';
      pPrice.value = p.price||'';
      pCategory.value = p.category||'Tecnología';
      pFeatured.checked = !!p.featured;
      btnDelete.classList.remove('hidden');
      modal.showModal();
    };

    window.removeProduct = async (id)=>{
      if(!confirm("¿Eliminar este producto?")) return;
      if(db){
        await window.cloud_delete(id);
      } else {
        products = products.filter(p=>p.id!==id);
        local_save(products);
        syncFeaturedLSFromProducts();
        renderCategories(products); applyFilters();
      }
    };

    btnAdd.addEventListener('click', ()=>{
      editingId = null;
      modalTitle.textContent = "Nuevo producto";
      form.reset();
      pFeatured.checked = false;
      btnDelete.classList.add('hidden');
      modal.showModal();
    });

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();

      const data = {
        title: pTitle.value.trim(),
        brand: pBrand.value.trim(),
        amazon: pAmazon.value.trim(),
        price: pPrice.value.trim(),
        category: pCategory.value,
        featured: !!pFeatured.checked
      };
      if(!data.title || !data.amazon){
        alert("Título y URL de Amazon son obligatorios."); return;
      }
      data.amazon = /[?&]tag=/.test(data.amazon) ? data.amazon : `${data.amazon}${data.amazon.includes('?')?'&':'?'}tag=${"kaninosabioan-20"}`;

      let finalImage = (pImageUrl.value||'').trim();
      if(pImageFile.files[0]){
        if(db){
          finalImage = await window.cloud_upload(pImageFile.files[0]);
        } else {
          finalImage = await fileToDataURL(pImageFile.files[0]);
        }
      }
      if(!finalImage){ alert("Debes subir una imagen o pegar una URL."); return; }
      data.image = finalImage;

      const id = editingId || uid();

      if(db){
        try{
          await window.cloud_save(id, data);
        }catch(e){
          console.warn('No se pudo guardar en Firestore, guardo local:', e);
          window.__ms360_skipRemoteOnce = true;
          if(editingId){
            products = products.map(p=> p.id===id ? ({...p, ...data}) : p);
          } else {
            products = [{ id, ...data, createdAt: Date.now() }, ...products];
          }
          local_save(products);
        }
      } else {
        if(editingId){
          products = products.map(p=> p.id===id ? ({...p, ...data}) : p);
        } else {
          products = [{ id, ...data, createdAt: Date.now() }, ...products];
        }
        local_save(products);
      }

      syncFeaturedLSFromProducts();
      renderCategories(products); applyFilters();
      editingId = null; form.reset(); pFeatured.checked = false; btnDelete.classList.add('hidden'); modal.close();
    });

    btnDelete.addEventListener('click', async ()=>{
      if(editingId){ await window.removeProduct(editingId); }
      editingId = null; modal.close();
    });

    function updateAdminUI(){
      btnAdd.disabled = !isAdmin;
      btnVerify.classList.toggle('hidden', !isAdmin);
      btnFix.classList.toggle('hidden', !isAdmin);
      document.documentElement.classList.toggle('is-admin', !!isAdmin);
      applyFilters();
    }

    btnAdmin.addEventListener('click', ()=>{
      if(isAdmin){
        isAdmin = false;
        localStorage.removeItem('ja_admin');
        btnAdmin.textContent = 'Admin';
        updateAdminUI();
        return;
      }
      const key = prompt("Clave Admin:");
      if(key === ADMIN_KEY){
        isAdmin = true;
        localStorage.setItem('ja_admin','1');
        btnAdmin.textContent = 'Admin (ON)';
        updateAdminUI();
      } else {
        alert("Clave incorrecta.");
      }
    });

    btnSettings.addEventListener('click', ()=>{
      adminKeyLabel.textContent = ADMIN_KEY;
      adminKeyInput.value = '';
      firebaseConfigInput.value = localStorage.getItem('ja_cloud_cfg') || '';
      cloudStatus.textContent = db ? 'Estado: Nube conectada' : 'Estado: Local';
      settings.showModal();
    });

    saveAdminKey.addEventListener('click', ()=>{
      const k = (adminKeyInput.value||'').trim();
      if(!k){ alert('Escribe una clave'); return; }
      ADMIN_KEY = k;
      localStorage.setItem('ja_admin_key', k);
      adminKeyLabel.textContent = k;
      alert('Clave guardada');
    });

    btnConnectCloud.addEventListener('click', async ()=>{
      const raw = (firebaseConfigInput.value||'').trim();
      if(!raw){ alert('Pega aquí tu firebaseConfig JSON'); return; }
      try{
        const cfg = JSON.parse(raw);
        localStorage.setItem('ja_cloud_cfg', JSON.stringify(cfg));
        await cloud_init(cfg);
        cloudStatus.textContent = 'Estado: Nube conectada';
        alert('¡Nube conectada! Ahora todo se sincroniza entre web y teléfono.');
      }catch(e){ console.error(e); alert('Config inválida. Asegúrate de pegar JSON válido.'); }
    });

    btnDisconnectCloud.addEventListener('click', ()=>{
      localStorage.removeItem('ja_cloud_cfg');
      if(unsub) unsub();
      db = null; storage=null;
      products = local_load();
      syncFeaturedLSFromProducts();
      renderCategories(products); applyFilters();
      cloudStatus.textContent = 'Estado: Local';
      alert('Se desconectó la nube. Ahora estás en modo local.');
    });

    search.addEventListener('input', applyFilters);
    categoryFilter.addEventListener('change', applyFilters);

    // ===== Verificador & Auto-Fix de tag Amazon (admin) =====
    const TAG = "kaninosabioan-20";
    const LS_VERIFY_KEY = "ja_store_products_v2";
    function verifyDOM() {
      const as = Array.from(document.querySelectorAll('a[href*="amazon."]'));
      const rows = as.map((a,i) => {
        let tag = null;
        try { tag = new URL(a.href, location.href).searchParams.get("tag"); } catch {}
        return { idx: i+1, text: (a.textContent||'').trim(), tag, href: a.href, ok: tag === TAG };
      });
      const bad = rows.filter(r => !r.ok);
      return { total: rows.length, ok: rows.length - bad.length, fail: bad.length, bad };
    }
    function verifyLS() {
      let list = [];
      try { list = JSON.parse(localStorage.getItem(LS_VERIFY_KEY)) || []; } catch {}
      const rows = list.map((p,i) => {
        let tag = null;
        try { tag = new URL(p.amazon, location.href).searchParams.get("tag"); }
        catch { const m = /\btag=([^&#]+)/.exec(p.amazon||""); tag = m && m[1] || null; }
        return { idx: i+1, id:p.id, title:p.title, tag, ok: tag === TAG, amazon:p.amazon };
      });
      const bad = rows.filter(r => !r.ok);
      return { total: rows.length, ok: rows.length - bad.length, fail: bad.length, bad };
    }
    function fixDOM() {
      document.querySelectorAll('a[href*="amazon."]').forEach(a => {
        try {
          const u = new URL(a.getAttribute("href"), location.href);
          u.searchParams.set("tag", TAG);
          a.href = u.toString();
          a.setAttribute("rel","nofollow noopener sponsored");
          a.setAttribute("target","_blank");
        } catch(e) {
          const href = a.getAttribute("href")||"";
          const sep = href.includes("?") ? "&" : "?";
          a.href = href + sep + "tag=" + TAG;
        }
      });
    }
    function fixLS() {
      let list = [];
      try { list = JSON.parse(localStorage.getItem(LS_VERIFY_KEY)) || []; } catch {}
      const fix = (url) => {
        if (!url) return url;
        try { const u = new URL(url, location.href); u.searchParams.set("tag", TAG); return u.toString(); }
        catch { const sep = url.includes("?") ? "&" : "?"; return url + sep + "tag=" + TAG; }
      };
      list = list.map(p => ({ ...p, amazon: fix(p.amazon) }));
      localStorage.setItem(LS_VERIFY_KEY, JSON.stringify(list));
    }
    btnVerify.addEventListener('click', () => {
      const dom = verifyDOM();
      const ls = verifyLS();
      const msg =
        `DOM → Total: ${dom.total} | OK: ${dom.ok} | FAIL: ${dom.fail}\n` +
        `LS  → Total: ${ls.total} | OK: ${ls.ok} | FAIL: ${ls.fail}\n\n` +
        `Detalles en la consola (F12 → Console).`;
      alert(msg);
      console.log("[Resumen] DOM:", dom, "| LS:", ls);
    });
    btnFix.addEventListener('click', () => {
      if(!confirm("¿Aplicar Auto-Fix? (DOM + LocalStorage)\nLuego recarga la página para ver los cambios en las tarjetas)")) return;
      fixDOM();
      fixLS();
      alert("✅ Auto-Fix aplicado.\n• DOM corregido\n• LocalStorage normalizado\n\nRecarga la página para reflejarlo en las tarjetas.");
    });

    // Auto-config: localStorage → AUTO_FIREBASE_CONFIG → firebaseConfig.json
    async function getAutoConfig(){
      const savedCfg = localStorage.getItem('ja_cloud_cfg');
      if(savedCfg){ try{ return JSON.parse(savedCfg) }catch{}}
      if (window.AUTO_FIREBASE_CONFIG && window.AUTO_FIREBASE_CONFIG.apiKey) return window.AUTO_FIREBASE_CONFIG;
      try{
        const res = await fetch('firebaseConfig.json?'+Date.now(), {cache:'no-store'});
        if(res.ok){ return await res.json(); }
      }catch{}
      return null;
    }

    window.addEventListener('DOMContentLoaded', async ()=>{
      isAdmin = !!localStorage.getItem('ja_admin');
      btnAdmin.textContent = isAdmin ? 'Admin (ON)' : 'Admin';

      const autoCfg = await getAutoConfig();
      if(autoCfg){
        try{
          await cloud_init(autoCfg);
          cloudStatus.textContent = 'Estado: Nube conectada';
        }catch(e){
          console.warn('No se pudo conectar a la nube. Usando local.', e);
          products = local_load();
          syncFeaturedLSFromProducts();
          renderCategories(products); applyFilters();
        }
      } else {
        products = local_load();
        syncFeaturedLSFromProducts();
        renderCategories(products); applyFilters();
      }
    });
  </script>

  <!-- Auto-SYNC con GitHub (products.json) -->
  <script>
  (function(){
    const RAW_URL = "https://raw.githubusercontent.com/jefersonsalazar2000-gif/STORE-3/refs/heads/main/products.json";
    const LS_KEY  = "ja_store_products_v2";
    const TAG     = "kaninosabioan-20";
    const REFRESH_MS = 30000;

    function lsLoad(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)) || [] }catch{ return [] } }
    function lsSave(v){ localStorage.setItem(LS_KEY, JSON.stringify(v)) }

    function asinFrom(url){
      try{
        const u = new URL(url);
        const m1 = u.pathname.match(/\/dp\/([A-Z0-9]{10})/i);
        const m2 = u.pathname.match(/\/gp\/product\/([A-Z0-9]{10})/i);
        const m3 = u.pathname.match(/\/([A-Z0-9]{10})(?:[\/?]|$)/i);
        const asin = (m1?.[1] || m2?.[1] || m3?.[1] || "").toUpperCase();
        return /^[A-Z0-9]{10}$/.test(asin) ? asin : null;
      }catch{ return null; }
    }
    function canonicalAmazon(url){
      if(!url) return "#";
      try{
        const u = new URL(url);
        if(!/amazon\./i.test(u.hostname)) return url;
        const asin = asinFrom(url);
        if(asin){
          const tag = u.searchParams.get('tag');
          u.pathname = `/dp/${asin}`;
          u.search = "";
          if(tag) u.searchParams.set('tag', tag);
          return u.toString();
        }
        return url;
      }catch{ return url; }
    }
    function stableKey(obj){
      const amazon = obj.amazon || obj.AMAZON || "";
      const asin = asinFrom(amazon);
      if (asin) return `asin:${asin}`;
      const t = (obj.title || obj.TITLE || "").toLowerCase().replace(/\s+/g,' ').trim();
      return `t:${t}`;
    }
    function tagify(url){
      if(!url) return "#";
      try{
        const u = new URL(url);
        if(!/amazon\./i.test(u.hostname)) return url;
        u.searchParams.set("tag", "kaninosabioan-20");
        return u.toString();
      }catch{
        const sep = url.includes('?') ? '&' : '?';
        return `${url}${sep}tag=${"kaninosabioan-20"}`;
      }
    }
    function normalize(entry){
      const p = entry || {};
      const canon = canonicalAmazon(p.AMAZON || p.amazon || "");
      const obj = {
        id: null,
        title: p.TITLE || p.title || "",
        brand: p.BRAND || p.brand || "",
        image: (p.IMAGE && p.IMAGE.trim()) || "https://via.placeholder.com/800x600?text=Imagen",
        amazon: tagify(canon || p.AMAZON || p.amazon || "#"),
        price: p.PRICE || p.price || "",
        category: p.CATEGORY || p.category || "Otros",
        featured: !!(p.FEATURE || p.featured),
        createdAt: Date.now()
      };
      obj.id = stableKey(obj);
      return obj;
    }
    function mergeDedup(existingList, incomingList){
      const map = new Map();
      for (const ex of existingList || []) {
        const k = stableKey(ex);
        map.set(k, { ...ex, id: k, featured: !!ex.featured });
      }
      for (const inc of (incomingList || [])) {
        const k = stableKey(inc);
        const prev = map.get(k);
        if (!prev) {
          map.set(k, { ...inc, id: k, featured: !!inc.featured });
        } else {
          const featuredLocal = !!prev.featured;
          map.set(k, { ...prev, ...inc, id: k, featured: featuredLocal });
        }
      }
      return Array.from(map.values())
        .sort((a,b)=> (b.featured - a.featured) || String(a.title).localeCompare(String(b.title)));
    }
    let lastText = null;
    async function pull(){
      try{
        const res = await fetch(RAW_URL + "?" + Date.now(), { cache:"no-store" });
        if(!res.ok) throw new Error("HTTP "+res.status);
        const text = await res.text();
        if(text === lastText) return;
        lastText = text;

        const data = JSON.parse(text);
        const incoming = Object.values(data.PRODUCTOS || {}).map(normalize);

        const current = lsLoad();
        const merged  = mergeDedup(current, incoming);

        lsSave(merged);
        window.dispatchEvent(new Event('ja_products_updated'));
        console.log("✅ Auto-sync: productos actualizados (⭐ preservados)");
      }catch(e){
        console.warn("[auto-sync] No se pudo leer products.json:", e);
      }
    }
    pull();
    setInterval(pull, REFRESH_MS);
    document.addEventListener('visibilitychange', () => { if (!document.hidden) pull(); });
  })();
  </script>

  <!-- RESET -->
  <script>
  async function resetStore(force=false) {
    try {
      localStorage.clear();
      if ('caches' in window) {
        const keys = await caches.keys();
        await Promise.all(keys.map(k => caches.delete(k)));
      }
      if ('serviceWorker' in navigator) {
        const regs = await navigator.serviceWorker.getRegistrations();
        await Promise.all(regs.map(r => r.unregister()));
      }
      if (force) location.replace(location.pathname + '?nocache=' + Date.now());
      else location.reload();
    } catch (e) { location.reload(); }
  }
  </script>

  <!-- Forzar tag afiliado en enlaces renderizados -->
  <script>
  (function(){
    const TAG = "kaninosabioan-20";
    function fixHref(h){
      try{ const u=new URL(h, location.href); if(!/amazon\./i.test(u.hostname)) return h; u.searchParams.set("tag", TAG); return u.toString(); }
      catch{ const sep = h.includes('?') ? '&' : '?'; return `${h}${sep}tag=${TAG}`; }
    }
    function patchLinks(){
      document.querySelectorAll('a[href*="amazon."]').forEach(a=>{
        a.href = fixHref(a.getAttribute('href'));
        a.setAttribute('rel','nofollow noopener sponsored');
        a.setAttribute('target','_blank');
      });
    }
    window.addEventListener('load', patchLinks);
    new MutationObserver(patchLinks).observe(document.body, { childList:true, subtree:true });
  })();
  </script>

  <!-- PWA -->
  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("sw.js").catch(()=>{});
      });
    }
  </script>

  <!-- ===== Login Admin seguro (acceso temporal) ===== -->
  <dialog id="admin-login" class="backdrop:bg-black/70 w-[min(420px,92vw)] rounded-2xl">
    <form method="dialog" class="card rounded-2xl p-5">
      <h3 class="text-lg font-extrabold neon-title mb-3">Acceso privado</h3>
      <p class="text-sm text-white/70 mb-3">Solo el dueño puede entrar. Sesión expira en 15 minutos.</p>
      <div class="gradient-border mb-3">
        <input id="adm-pass" type="password" class="input w-full" autocomplete="current-password" placeholder="Clave secreta" />
      </div>
      <div class="flex items-center justify-between gap-2">
        <button value="cancel" class="chip px-3 py-2 rounded-xl text-sm">Cancelar</button>
        <div class="flex gap-2">
          <button id="adm-change" type="button" class="chip px-3 py-2 rounded-xl text-sm">Cambiar clave</button>
          <button id="adm-enter" type="button" class="btn-neon px-4 py-2 rounded-xl text-sm">Entrar</button>
        </div>
      </div>
      <p id="adm-msg" class="text-xs text-white/60 mt-3"></p>
    </form>
  </dialog>

  <script>
  (function(){
    const HTMLCLS = document.documentElement;
    const btnAdmin   = document.getElementById('btnAdmin');
    const btnSettings= document.getElementById('btnSettings');
    const adminDlg   = document.getElementById('admin-login');
    const passInput  = document.getElementById('adm-pass');
    const enterBtn   = document.getElementById('adm-enter');
    const changeBtn  = document.getElementById('adm-change');
    const msg        = document.getElementById('adm-msg');
    const brand      = document.getElementById('brandTrigger');

    const _showModal = HTMLDialogElement.prototype.showModal;
    HTMLDialogElement.prototype.showModal = function(){
      if(this.id === 'settings' && !isActive()) { alert('Solo Admin'); return; }
      return _showModal.call(this);
    };

    const DEFAULT_ADMIN_HASH = '600f70101043abb7c5b1ab0bd909306f8f3d98fca2cd206f627aa7639fda5a49';
    const HASH_KEY = 'ja_admin_secret_hash';
    const SESSION_KEY = 'ms360_admin_until';

    const sha256 = async (txt) => {
      const enc = new TextEncoder().encode('ms360.v1' + txt);
      const buf = await crypto.subtle.digest('SHA-256', enc);
      return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
    };
    const now = () => Date.now();
    const isActive = () => {
      const until = +(sessionStorage.getItem(SESSION_KEY) || 0);
      return until && until > now();
    };
    const activate = (minutes=15) => {
      const until = now() + minutes*60*1000;
      sessionStorage.setItem(SESSION_KEY, String(until));
      HTMLCLS.classList.add('is-admin');
      localStorage.setItem('ja_admin','1');
    };
    const deactivate = () => {
      sessionStorage.removeItem(SESSION_KEY);
      HTMLCLS.classList.remove('is-admin');
      localStorage.removeItem('ja_admin');
      try { adminDlg.close(); } catch(e){}
    };

    if(isActive()) HTMLCLS.classList.add('is-admin');
    else HTMLCLS.classList.remove('is-admin');

    [btnAdmin, btnSettings].forEach(el=>{
      if(!el) return;
      el.addEventListener('click', (e)=>{
        if(!isActive()){
          e.preventDefault(); e.stopImmediatePropagation();
          openLogin();
        }
      }, true);
    });

    let clicks = 0, t=null, keyCount=0, keyTimer=null;
    function openLogin(){ passInput.value=''; msg.textContent=''; adminDlg.showModal(); setTimeout(()=>passInput.focus(), 80); }
    brand?.addEventListener('click', ()=>{
      clicks++; clearTimeout(t); t = setTimeout(()=>{ clicks=0 }, 400);
      if(clicks>=3){ clicks=0; openLogin(); }
    });
    document.addEventListener('keydown', (e)=>{
      if(e.shiftKey && (e.key==='A' || e.key==='a')){
        keyCount++; clearTimeout(keyTimer); keyTimer=setTimeout(()=>{keyCount=0}, 600);
        if(keyCount>=3){ keyCount=0; openLogin(); }
      }
    });

    enterBtn?.addEventListener('click', async ()=>{
      const pass = (passInput.value || '').trim();
      if(!pass){ msg.textContent='Escribe tu clave'; return; }
      const hash = await sha256(pass);
      const expected = localStorage.getItem(HASH_KEY) || DEFAULT_ADMIN_HASH;
      if(hash === expected){
        activate(15);
        msg.textContent = 'Acceso concedido. Recargando…';
        setTimeout(()=>location.reload(), 350);
      } else {
        msg.textContent = 'Clave incorrecta';
      }
    });

    changeBtn?.addEventListener('click', async ()=>{
      const newPass = prompt('Nueva clave secreta (no se guarda en texto plano):');
      if(!newPass) return;
      const h = await sha256(newPass.trim());
      localStorage.setItem(HASH_KEY, h);
      alert('✅ Clave cambiada. Usa la nueva para entrar.');
    });

    setInterval(()=>{
      if(!isActive() && HTMLCLS.classList.contains('is-admin')){
        deactivate();
        location.reload();
      }
    }, 15000);

  })();
  </script>

  <!-- ===== FAB + Modal Destacados (lista fija por ID) ===== -->
  <button id="fabDestacados" aria-label="Ver destacados" title="Ver destacados"
    style="position:fixed;bottom:20px;right:20px;z-index:9999;border:none;border-radius:9999px;padding:14px 16px;font-weight:700;cursor:pointer;box-shadow:0 10px 25px rgba(0,0,0,.25);background:linear-gradient(90deg,#ec4899,#8b5cf6,#06b6d4);color:#fff">
    ★ Destacados
  </button>

  <div id="modalDestacados" aria-hidden="true"
    style="position:fixed;inset:0;z-index:10000;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55)">
    <div role="dialog" aria-modal="true" aria-labelledby="destacadosTitle"
        style="width:min(1100px,92vw);max-height:86vh;overflow:auto;border-radius:16px;background:#0f1426;border:1px solid rgba(255,255,255,.06);box-shadow:0 20px 60px rgba(0,0,0,.35)">
      <div style="position:sticky;top:0;background:#0f1426;padding:16px 18px;border-bottom:1px solid rgba(255,255,255,.06);display:flex;gap:12px;align-items:center;justify-content:space-between">
        <div>
          <h3 id="destacadosTitle" style="margin:0;color:#fff;font-size:18px;font-weight:800">Productos destacados</h3>
          <small style="color:#aab3d1">Lista fija por ID (orden estable)</small>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="cerrarDestacados" aria-label="Cerrar"
            style="background:#ffffff14;color:#fff;border:1px solid #ffffff1f;border-radius:10px;padding:8px 12px;cursor:pointer">
            Cerrar
          </button>
        </div>
      </div>
      <div id="gridDestacados" style="padding:18px;display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:14px"></div>
      <div style="padding:12px 18px;border-top:1px solid rgba(255,255,255,.06);display:flex;justify-content:flex-end">
        <small style="color:#7f8ab2">Tip: en modo Admin puedes quitar/poner ⭐ aquí mismo.</small>
      </div>
    </div>
  </div>

  <style>
    .cardP { background:#0b0f1a;border:1px solid rgba(255,255,255,.06); border-radius:16px;overflow:hidden;display:flex;flex-direction:column; box-shadow:0 10px 24px rgba(0,0,0,.25); transition:transform .15s ease, box-shadow .15s ease; }
    .cardP:hover{ transform:translateY(-2px); box-shadow:0 14px 32px rgba(0,0,0,.32); }
    .imgWrap{ aspect-ratio:4/3; background:#0a0e1a; display:flex; align-items:center; justify-content:center; }
    .imgWrap img{ max-width:92%; max-height:92%; object-fit:contain; }
    .bodyP{ padding:12px 14px; display:flex; flex-direction:column; gap:8px; }
    .titleP{ color:#fff; font-weight:700; line-height:1.2; font-size:14px; min-height:34px; }
    .catP{ color:#9fb0d1; font-size:12px; }
    .rowBtns{ display:flex; gap:8px; margin-top:6px; }
    .btnAmazon{ flex:1; border:none; border-radius:10px; padding:8px 10px; font-size:12px; color:#fff; font-weight:700; cursor:pointer; background:linear-gradient(90deg,#ec4899,#8b5cf6,#06b6d4); }
    .btnSec{ border:none; border-radius:10px; padding:8px 10px; font-size:12px; color:#fff; background:#ffffff17; cursor:pointer; }
    .cardWrap{ position:relative; }
  </style>

  <script>
  (function(){
    const LS_KEY = "ja_store_products_v2";
    const TAG    = "kaninosabioan-20";
    const LS_FEATURED = "ja_featured_ids_v1";

    function getAllProducts(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        const list = raw ? JSON.parse(raw) : [];
        if (Array.isArray(list) && list.length) return list.map(p => ({
          id: p.id || crypto.randomUUID(),
          title: p.title || p.TITLE || "",
          image: p.image || p.IMAGE || "",
          amazon: p.amazon || p.AMAZON || "",
          category: p.category || p.CATEGORY || "Otros",
          featured: !!(p.featured ?? p.FEATURE)
        }));
      }catch{}
      return [];
    }

    function ensureAffiliate(url){
      if (!url) return "#";
      try{
        const u = new URL(url, location.href);
        if (/amazon\./i.test(u.hostname)) u.searchParams.set("tag", TAG);
        return u.toString();
      }catch{
        const sep = url.includes("?") ? "&" : "?";
        return url + sep + "tag=" + TAG;
      }
    }

    const modal = document.getElementById("modalDestacados");
    const fab   = document.getElementById("fabDestacados");
    const hdr   = document.getElementById("btnDestacadosHeader");
    const btnX  = document.getElementById("cerrarDestacados");
    const grid  = document.getElementById("gridDestacados");

    function card(p){
      const a = ensureAffiliate(p.amazon);
      const t = (p.title||"Producto").replace(/"/g,"&quot;");
      const i = p.image || "https://via.placeholder.com/800x600?text=Imagen";
      const c = p.category || "Otros";
      const star = document.documentElement.classList.contains('is-admin')
        ? `<button class="btnSec" data-star="${p.id}" aria-pressed="true" title="Quitar de Destacados">★</button>`
        : '';
      return `
      <div class="cardWrap">
        <div class="cardP">
          <div class="imgWrap"><img loading="lazy" alt="${t}" src="${i}"></div>
          <div class="bodyP">
            <div class="titleP">${t}</div>
            <div class="catP">${c}</div>
            <div class="rowBtns">
              <button class="btnAmazon" onclick="window.open('${a}','_blank','noopener,noreferrer')">Ver en Amazon</button>
              ${star}
            </div>
          </div>
        </div>
      </div>`;
    }

    function getFeaturedIds(){ try{return JSON.parse(localStorage.getItem(LS_FEATURED))||[]}catch{return[]} }
    function setFeaturedIds(v){ localStorage.setItem(LS_FEATURED, JSON.stringify(v||[])) }

    function renderModal(){
      const map = new Map(getAllProducts().map(p=>[p.id,p]));
      const ids = getFeaturedIds();
      const feats = ids.map(id=>map.get(id)).filter(Boolean);
      if (!feats.length){
        grid.innerHTML = `<div style="grid-column:1/-1;color:#aab3d1;text-align:center;padding:28px">No hay productos destacados. Marca ⭐ en cualquier tarjeta (modo Admin).</div>`;
        return;
      }
      grid.innerHTML = feats.map(card).join("");

      if (document.documentElement.classList.contains('is-admin')){
        grid.querySelectorAll('[data-star]').forEach(btn=>{
          btn.addEventListener('click', async ()=>{
            const id = btn.getAttribute('data-star');
            if (window.setFeatured) {
              await window.setFeatured(id, false);
            } else {
              const arr = getFeaturedIds().filter(x=>x!==id);
              setFeaturedIds(arr);
            }
            renderModal();
            if (typeof window.__renderFeaturedIfOpen === 'function') window.__renderFeaturedIfOpen();
          }, {passive:false});
        });
      }
    }

    function abrir(){ renderModal(); modal.style.display="flex"; modal.setAttribute("aria-hidden","false"); document.documentElement.style.overflow='hidden'; }
    function cerrar(){ modal.style.display="none"; modal.setAttribute("aria-hidden","true"); document.documentElement.style.overflow=''; }

    fab?.addEventListener("click", abrir);
    hdr?.addEventListener("click", abrir);
    btnX?.addEventListener("click", cerrar);
    modal?.addEventListener("click", (e)=>{ if (e.target === modal) cerrar(); });

    window.__renderFeaturedIfOpen = function(){ if (modal.style.display === "flex") renderModal(); };
    window.addEventListener("ja_products_updated", window.__renderFeaturedIfOpen);
    document.addEventListener("keydown", (e)=>{ if(e.key==="Escape" && modal.style.display==="flex"){ cerrar(); }});
  })();
  </script>

</body>
</html>
