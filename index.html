<!DOCTYPE html>
<html lang="es" class="h-full bg-[#0b0f1a]">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>J_A MEGA STORE 360</title>
  <meta name="theme-color" content="#0b0f1a"/>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json?v=7" />
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192x192-v7.png?v=7">
  <link rel="apple-touch-icon" href="icon-180x180-v7.png?v=7">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { outfit: ['Outfit','ui-sans-serif','system-ui']},
          colors: { base:'#0b0f1a', card:'#12172a', soft:'#1a2140' }
        }
      }
    }
  </script>

  <!-- Fuente -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --grad-1: linear-gradient(135deg,#00E5FF 0%, #7C3AED 50%, #FF0099 100%);
      --btn-grad: linear-gradient(135deg, #00E5FF 0%, #7C3AED 50%, #FF0099 100%);
      --ring: 0 0 0 1.5px rgba(124,58,237,.45), 0 0 18px rgba(124,58,237,.35), inset 0 0 12px rgba(0,229,255,.25);
    }
    body{ font-family:'Outfit',sans-serif }
    .neon-title{ background:var(--grad-1); -webkit-background-clip:text; background-clip:text; color:transparent; text-shadow:0 0 18px rgba(124,58,237,.25) }
    .btn-neon{ background:var(--btn-grad); color:#0b0f1a; font-weight:800; box-shadow:0 0 24px rgba(124,58,237,.35); transition:transform .12s, box-shadow .12s, opacity .12s }
    .btn-neon:hover{ transform:translateY(-1px) scale(1.005); box-shadow:0 0 32px rgba(124,58,237,.55) }
    .chip{ background:rgba(124,58,237,.15); border:1px solid rgba(124,58,237,.35) }
    .card{ background:radial-gradient(1200px 500px at -10% -10%, rgba(124,58,237,.12), transparent 50%), radial-gradient(1000px 400px at 120% 120%, rgba(0,229,255,.10), transparent 45%), #12172a; border:1px solid rgba(124,58,237,.25) }
    .toolbar{ background:linear-gradient(180deg, rgba(18,23,42,.85), rgba(18,23,42,.6) 60%, rgba(18,23,42,.1)); border-bottom:1px solid rgba(124,58,237,.25); backdrop-filter:blur(8px) }
    .gradient-border{ position:relative; border-radius:16px; overflow:hidden }
    .gradient-border::before{ content:''; position:absolute; inset:0; padding:1px; border-radius:16px; background:var(--grad-1);
      -webkit-mask:linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0); -webkit-mask-composite:xor; mask-composite:exclude; pointer-events:none }
    .input{ background:#0e1430; border:1px solid rgba(124,58,237,.35); outline:none; color:white; border-radius:12px; padding:.7rem .9rem }
    .input:focus{ box-shadow:var(--ring) }
    html, body { max-width:100%; overflow-x:hidden; }
    body { touch-action: pan-y; overscroll-behavior-x: none; }
    #grid { overflow-x:hidden; }
    *, *::before, *::after { box-sizing:border-box; }

    /* Admin oculto por defecto */
    .admin-only{ display:none !important; }
    .is-admin .admin-only{ display:inline-flex !important; }

    /* Botones del header ocultos salvo modo admin */
    .header-admin-btn{ display:none !important; }
    .is-admin .header-admin-btn{ display:inline-flex !important; }

    /* Logo Amazon */
    .logo-chip{ background:#fff !important; border:1px solid rgba(255,255,255,.12) }
    .logo-chip img{ display:block; height:24px; width:auto; max-width:92px }
    @media (min-width:640px){ .logo-chip img{ height:26px } }

    /* Bloqueo de scroll del fondo cuando el revisor está abierto */
    .no-scroll{ position:fixed; overflow:hidden; width:100%; }
  </style>

  <!-- Add-ons UI -->
  <style>
    :root { --ms360-ring: 0 0 0 1.5px rgba(124,58,237,.45), 0 0 18px rgba(124,58,237,.35), inset 0 0 12px rgba(0,229,255,.25) }
    :focus-visible { outline:2px solid #7C3AED; outline-offset:2px }
    .ms360-skeleton{position:relative;overflow:hidden;background:#0f1430}
    .ms360-skeleton::after{content:"";position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,.08),transparent);transform:translateX(-100%);animation:ms360-shimmer 1.1s infinite}
    #ms360-top{position:fixed;right:14px;bottom:14px;z-index:9998;opacity:0;pointer-events:none;transform:translateY(8px);transition:opacity .2s, transform .2s}
    #ms360-top.ms360-show{opacity:1;pointer-events:auto;transform:translateY(0)}
    #ms360-toasts{position:fixed;bottom:18px;left:50%;transform:translateX(-50%);z-index:10000;display:grid;gap:8px}
    .ms360-ibtn{display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px;border-radius:10px;background:rgba(14,20,48,.75);border:1px solid rgba(255,255,255,.12);color:#fff;backdrop-filter:blur(6px);transition:transform .12s,border-color .12s}
    .ms360-ibtn:hover{transform:translateY(-1px) scale(1.03);border-color:rgba(255,255,255,.25)}
  </style>

  <!-- Ocultar FAB y botón del header “Destacados” -->
  <style>#fabDestacados, #btnDestacadosHeader { display: none !important; }</style>

  <!-- Tiles -->
  <style id="ms360-tiles-essence">
    html.ms360-tiles #grid{ display:grid !important; grid-template-columns:repeat(3,minmax(0,1fr)) !important; gap:12px !important; }
    html.ms360-tiles #grid .card{
      background:
        radial-gradient(900px 480px at 110% -10%, rgba(0,229,255,.08), transparent 55%),
        radial-gradient(900px 480px at -10% 120%, rgba(124,58,237,.10), transparent 50%),
        #12172a !important;
      border:1px solid rgba(124,58,237,.22) !important;
      box-shadow:0 10px 28px rgba(0,0,0,.35) !important;
      color:#E7ECFF !important;
      border-radius:18px !important;
      padding:10px !important;
    }
    html.ms360-tiles #grid .card .aspect-\[4\/3\]{ aspect-ratio:1/1 !important; background:#fff !important; border-radius:14px !important; padding:8px !important; position:relative; overflow:hidden; }
    html.ms360-tiles #grid .card .aspect-\[4\/3\]::before{
      content:""; position:absolute; inset:0; padding:1px; border-radius:14px; background:var(--grad-1);
      -webkit-mask:linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0); -webkit-mask-composite:xor; mask-composite:exclude; pointer-events:none; opacity:.45;
    }
    html.ms360-tiles #grid .card .aspect-\[4\/3\] img{ object-fit:contain !important; width:100% !important; height:100% !important; mix-blend:multiply; filter:saturate(1.02) contrast(1.02); }
    html.ms360-tiles #grid .card h3{
      color:#fff !important; font-weight:800 !important; font-size:13px !important; line-height:1.25 !important; text-align:center !important; margin-top:10px !important;
      display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; min-height:2.6em; text-shadow:0 0 14px rgba(124,58,237,.22);
    }
    html.ms360-tiles #grid .card a.btn-neon{ width:100% !important; justify-content:center !important; padding:8px 10px !important; font-size:12px !important; border-radius:10px !important; margin-top:10px !important; transform:none !important; }
    html.ms360-tiles #grid .card a.btn-neon:hover{ transform:none !important; }
    @media (min-width:640px){ html.ms360-tiles #grid{ grid-template-columns:repeat(4,minmax(0,1fr)) !important; } }
    @media (min-width:1024px){ html.ms360-tiles #grid{ grid-template-columns:repeat(5,minmax(0,1fr)) !important; } }
  </style>
</head>

<body class="min-h-full text-white bg-[radial-gradient(1200px_600px_at_20%_-10%,rgba(124,58,237,.15),transparent_55%),radial-gradient(900px_500px_at_120%_10%,rgba(0,229,255,.12),transparent_50%),#0b0f1a]">

  <!-- Header -->
  <header class="toolbar sticky top-0 z-30">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3">
      <div id="brandTrigger" class="w-10 h-10 rounded-xl gradient-border flex items-center justify-center shrink-0 select-none">
        <div class="w-full h-full rounded-[14px] bg-[#0e1430] flex items-center justify-center">
          <span class="text-xl font-extrabold neon-title">J_A</span>
        </div>
      </div>
      <div class="flex-1">
        <h1 class="text-xl sm:text-2xl font-extrabold neon-title leading-none">MEGA STORE 360</h1>
        <p class="text-xs neon-title -mt-0.5">De todo • Tecnología • Hogar • Accesorios</p>
      </div>

      <a href="http://www.youtube.com/@SABIDURIAANIMAL86" target="_blank" class="px-3 py-2 rounded-xl chip text-sm font-semibold hover:opacity-90">YouTube</a>

      <!-- Amazon (logo oficial, nítido) -->
      <a href="https://www.amazon.com/?tag=kaninosabioan-20"
         target="_blank" rel="nofollow sponsored noopener"
         class="ml-1 inline-flex items-center justify-center h-10 rounded-xl px-3 logo-chip"
         title="Ir a Amazon (afiliado)">
        <img src="https://upload.wikimedia.org/wikipedia/commons/a/a9/Amazon_logo.svg" alt="Amazon" referrerpolicy="no-referrer" loading="eager"/>
      </a>

      <!-- Botones ocultos por defecto; solo visibles en modo admin -->
      <div class="flex items-center gap-2">
        <button id="btnSettings" class="px-3 py-2 rounded-xl chip text-sm font-semibold hover:opacity-90 header-admin-btn">Ajustes</button>
        <button id="btnAdmin" class="px-3 py-2 rounded-xl chip text-sm font-semibold hover:opacity-90 header-admin-btn">Salir Admin</button>
        <button id="btnVerify" class="px-3 py-2 rounded-xl chip text-sm font-semibold hover:opacity-90 header-admin-btn hidden">Verificar Tag</button>
        <button id="btnFix" class="px-3 py-2 rounded-xl chip text-sm font-semibold hover:opacity-90 header-admin-btn hidden">Auto-Fix Tag</button>
        <button id="btnDestacadosHeader" class="px-3 py-2 rounded-xl chip text-sm font-semibold hover:opacity-90">★ Destacados</button>
      </div>
    </div>
  </header>

  <!-- Controles -->
  <section class="max-w-7xl mx-auto px-4 mt-4 grid gap-3 sm:grid-cols-[1fr_auto_auto]">
    <div class="gradient-border">
      <input id="search" class="input w-full" placeholder="Buscar productos… (escribe /admin y Enter para modo admin)" />
    </div>
    <select id="categoryFilter" class="input">
      <option value="all">Todas las categorías</option>
    </select>
    <button id="btnAdd" class="btn-neon px-4 py-2 rounded-xl text-sm disabled:opacity-40 admin-only" disabled>+ Agregar</button>
  </section>

  <!-- Grid -->
  <main class="max-w-7xl mx-auto px-4 py-6">
    <div id="grid" class="grid gap-4 grid-cols-2 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4"></div>
    <p id="empty" class="hidden text-center text-white/60 mt-10">No hay productos que coincidan.</p>
  </main>

  <!-- Footer -->
  <footer class="border-t border-white/10 py-8">
    <div class="max-w-7xl mx-auto px-4 text-sm text-white/60">
      <div class="flex flex-wrap items-center gap-2">
        <span class="font-semibold">Aviso Amazon Afiliados:</span>
        <span>Como afiliado de Amazon, puedo ganar comisiones por compras calificadas.</span>
      </div>
      <div class="mt-2">© <span id="year"></span> J_A MEGA STORE 360 — Todos los derechos reservados.</div>
    </div>
  </footer>

  <!-- ===================== APP PRINCIPAL ===================== -->
  <script type="module">
    const AFF_TAG = "kaninosabioan-20";
    const LS_KEY  = 'ja_store_products_v2';
    const LS_FEATURED = 'ja_featured_ids_v1';
    const MIGRATION_FLAG = 'ja_migrated_2025_10_08_fix_ids_v7';

    // ---- Migración (limpia datos locales antiguos)
    if (!localStorage.getItem(MIGRATION_FLAG)) {
      try { localStorage.removeItem(LS_KEY); localStorage.removeItem(LS_FEATURED); } catch {}
      localStorage.setItem(MIGRATION_FLAG, '1');
    }

    // ---- Featured
    const feat = {
      get(){ try{return JSON.parse(localStorage.getItem(LS_FEATURED))||[]}catch{return[]} },
      set(v){ localStorage.setItem(LS_FEATURED, JSON.stringify(v||[])) },
      has(id){ return feat.get().includes(id) },
      toggle(id){ const s=new Set(feat.get()); s.has(id)?s.delete(id):s.add(id); feat.set([...s]) }
    };

    // ---- Afiliado
    function ensureTag(url){
      if(!url) return "#";
      try{
        const u=new URL(url,location.href);
        if(/amazon\./i.test(u.hostname)) u.searchParams.set("tag", AFF_TAG);
        return u.toString();
      }catch{
        const sep=url.includes("?")?"&":"?";
        return `${url}${sep}tag=${AFF_TAG}`;
      }
    }

    // ---- Normalizador
    const norm = (p)=>({
      id: (p.id || '').trim(),
      title: (p.title || p.TITLE || '').trim(),
      brand: (p.brand || p.BRAND || '').trim(),
      image: (p.image || p.IMAGE || '').trim(),
      amazon: ensureTag(p.amazon || p.AMAZON || '#'),
      price: p.price ?? p.PRICE ?? '',
      category: (p.category || p.CATEGORY || 'Otros').trim(),
      featured: !!(p.featured ?? p.FEATURE),
      createdAt: typeof p.createdAt==='number' ? p.createdAt : Date.now()
    });

    // ---- Estado UI
    let products = [];
    let isAdmin = !!localStorage.getItem('ja_admin');

    const grid = document.getElementById('grid');
    const empty = document.getElementById('empty');
    const search = document.getElementById('search');
    const categoryFilter = document.getElementById('categoryFilter');
    const btnAdd = document.getElementById('btnAdd');
    const year = document.getElementById('year');
    year.textContent = new Date().getFullYear();

    // ---- Render
    function productCard(p){
      const nprice = Number(p.price);
      const showPrice = Number.isFinite(nprice) && nprice > 0;
      const price = showPrice ? `${nprice.toLocaleString()}` : '';

      const starBtn = `
        <button class="admin-only ms360-star absolute top-2 right-2 z-10 bg-[rgba(14,20,48,.8)] border border-white/15 rounded-lg px-2 py-1 text-sm"
                data-star="${p.id}" aria-pressed="${feat.has(p.id)?'true':'false'}"
                title="${feat.has(p.id)?'Quitar de primeros':'Fijar al inicio'}">
          ${feat.has(p.id)?'★':'☆'}
        </button>`;
      return `
        <article class="card rounded-2xl p-3 sm:p-4 flex flex-col gradient-border relative">
          ${starBtn}
          <div class="rounded-xl overflow-hidden bg-soft aspect-[4/3]">
            <img src="${p.image}${p.image?.includes('?')?'&':'?'}v=${encodeURIComponent(p.id||'13')}"
                 alt="${p.title}" class="w-full h-full object-contain" loading="lazy"
                 onerror="this.onerror=null;this.src='https://via.placeholder.com/800x600?text=Imagen';">
          </div>
          <div class="mt-3">
            <h3 class="font-extrabold leading-tight line-clamp-2 text-center">${p.title}</h3>
            <div class="mt-1 text-center text-xs text-white/60">${p.category}${p.brand?` • ${p.brand}`:''}</div>
            ${price?`<div class="mt-1 text-center text-white/90 font-semibold">${price}</div>`:''}
            <a href="${ensureTag(p.amazon)}" target="_blank" rel="nofollow sponsored noopener"
               class="btn-neon w-full justify-center px-4 py-2 rounded-xl inline-flex items-center gap-2 mt-3">
              Ver en Amazon
            </a>
          </div>
        </article>`;
    }

    function sortFeatured(list){
      return [...list].sort((a,b)=>{
        const fa = feat.has(a.id)?1:0, fb = feat.has(b.id)?1:0;
        if (fa !== fb) return fb - fa;
        return String(a.title).localeCompare(String(b.title));
      });
    }

    function renderCategories(list){
      const cats = ['all', ...new Set(list.map(p=>p.category))];
      categoryFilter.innerHTML = cats.map(c => `<option value="${c}">${c==='all'?'Todas las categorías':c}</option>`).join('');
    }

    function applyFilters(){
      const term = (search.value||'').toLowerCase().trim();
      const cat = categoryFilter.value||'all';
      const filtered = products.filter(p=>{
        const t = !term || p.title.toLowerCase().includes(term) || (p.brand||'').toLowerCase().includes(term);
        const c = cat==='all' || p.category===cat;
        return t && c;
      });
      const ordered = sortFeatured(filtered);
      grid.innerHTML = ordered.map(productCard).join('');
      empty.classList.toggle('hidden', !!ordered.length);

      grid.querySelectorAll('[data-star]').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
          e.stopPropagation();
          if(!isAdmin){ alert('Solo Admin'); return; }
          const id = btn.getAttribute('data-star');
          feat.toggle(id);
          applyFilters();
          if (typeof window.__renderFeaturedIfOpen === 'function') window.__renderFeaturedIfOpen();
        }, {passive:false});
      });
    }

    function loadLocal(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        const list = raw ? JSON.parse(raw) : [];
        return Array.isArray(list) ? list.map(norm) : [];
      }catch{ return []; }
    }
    function saveLocal(list){ localStorage.setItem(LS_KEY, JSON.stringify(list)); }

    // ---- Inicio
    products = loadLocal();
    renderCategories(products); applyFilters();

    // ---- Filtros
    search.addEventListener('input', applyFilters, {passive:true});
    categoryFilter.addEventListener('change', applyFilters, {passive:true});

    // ---- Activación Admin (4 métodos)
    function setAdmin(on){
      isAdmin = !!on;
      document.documentElement.classList.toggle('is-admin', isAdmin);
      if (isAdmin) localStorage.setItem('ja_admin','1'); else localStorage.removeItem('ja_admin');
      applyFilters();
    }
    // 1) /admin + Enter
    search.addEventListener('keydown',(e)=>{
      if (e.key==='Enter' && search.value.trim().toLowerCase()==='/admin'){
        e.preventDefault(); search.value=''; setAdmin(!isAdmin);
      }
    });
    // 2) Atajos
    document.addEventListener('keydown', (e)=>{
      const k = e.key.toLowerCase();
      if ((e.altKey && k==='a') || (e.metaKey && e.shiftKey && k==='a') || (e.ctrlKey && e.shiftKey && k==='a')){
        e.preventDefault(); setAdmin(!isAdmin);
      }
    }, {passive:false});
    // 3) Long-press J_A
    (function(){
      const trigger = document.getElementById('brandTrigger');
      let t=null;
      trigger.addEventListener('pointerdown', ()=>{ t=setTimeout(()=>setAdmin(!isAdmin), 1200); });
      const clear=()=>{ if(t){clearTimeout(t); t=null;} };
      ['pointerup','pointerleave','pointercancel'].forEach(ev=>trigger.addEventListener(ev, clear));
    })();
    // 4) ?admin=1 o #admin
    (function(){
      const sp = new URLSearchParams(location.search);
      if (sp.get('admin')==='1' || location.hash.includes('admin')) setAdmin(true);
    })();

    document.getElementById('btnAdmin')?.addEventListener('click', ()=> setAdmin(false));

    // ================== AUTO-SYNC GITHUB (REPLACE + ID estable) ==================
    (function(){
      const RAW_URL = "https://raw.githubusercontent.com/jefersonsalazar2000-gif/STORE-3/refs/heads/main/products.json";
      const REFRESH_MS = 30000;

      function normalizeIncoming(data){
        const obj = data && data.PRODUCTOS ? data.PRODUCTOS : {};
        return Object.entries(obj).map(([id, data]) => ({ ...data, id })).map(norm);
      }

      async function pull(){
        try{
          const res = await fetch(RAW_URL + "?" + Date.now(), { cache:"no-store" });
          if(!res.ok) throw new Error("HTTP "+res.status);
          const json = await res.json();

          const incoming = normalizeIncoming(json).filter(p => p.title && p.image);
          incoming.forEach(p => p.amazon = ensureTag(p.amazon));

          saveLocal(incoming);
          products = loadLocal();
          products = applyImageOverrides(products);
          renderCategories(products); applyFilters();
          window.dispatchEvent(new Event('ja_products_updated'));
          console.log("✅ Auto-sync REPLACE (IDs estables): productos =", products.length);
        }catch(e){
          console.warn("[auto-sync] No se pudo leer products.json:", e);
        }
      }

      pull();
      setInterval(pull, REFRESH_MS);
      document.addEventListener('visibilitychange', () => { if (!document.hidden) pull(); });
    })();

    // ---- Parche universal + Interceptor de clic para tag
    (function(){
      function patch(){
        document.querySelectorAll('a[href*="amazon."]').forEach(a=>{
          a.href = ensureTag(a.getAttribute('href')||'#');
          a.rel = 'nofollow noopener sponsored';
          a.target = '_blank';
        });
      }
      document.addEventListener('click', (ev)=>{
        const a = ev.target.closest && ev.target.closest('a[href]');
        if(!a) return;
        try{
          const u = new URL(a.href, location.href);
          if(/amazon\./i.test(u.hostname)){
            u.searchParams.set('tag', AFF_TAG);
            ev.preventDefault();
            window.open(u.toString(), '_blank', 'noopener');
          }
        }catch{}
      }, {capture:true});
      window.addEventListener('load', patch, {once:true});
      new MutationObserver(patch).observe(document.body,{childList:true,subtree:true});
    })();

    /* ======== REVISOR DE IMÁGENES (MODO ADMIN) ======== */
    const LS_OVERRIDES = 'ja_image_overrides_v1';
    function getOverrides(){ try{return JSON.parse(localStorage.getItem(LS_OVERRIDES))||{}}catch{return{}} }
    function setOverrides(v){ localStorage.setItem(LS_OVERRIDES, JSON.stringify(v||{})); }
    function applyImageOverrides(list){
      const map = getOverrides();
      return list.map(p => { if (map[p.id]?.image) p.image = map[p.id].image; return p; });
    }

    let __scrollY = 0;
    function lockScroll(){ __scrollY = window.scrollY||0; document.body.classList.add('no-scroll'); document.body.style.top=`-${__scrollY}px`; }
    function unlockScroll(){ document.body.classList.remove('no-scroll'); document.body.style.top=''; window.scrollTo(0,__scrollY); }

    (function(){
      const btn = document.createElement('button');
      btn.textContent = 'Revisar imágenes';
      btn.id = 'imgAuditBtn';
      btn.className = 'admin-only fixed bottom-20 right-4 z-[10001] px-4 py-2 rounded-xl chip font-semibold';
      btn.addEventListener('click', openAuditPanel);
      document.addEventListener('DOMContentLoaded', ()=> document.body.appendChild(btn), {once:true});
    })();

    function openAuditPanel(){
      const dupes = findDuplicateImages(products);
      const suspects = findSuspects(products);

      const wrap = document.createElement('div');
      wrap.id = 'imgAuditPanel';
      wrap.style.cssText = 'position:fixed;inset:0;z-index:10002;background:rgba(0,0,0,.55);display:flex;align-items:center;justify-content:center;padding:16px;overflow:auto';
      wrap.innerHTML = `
        <div class="card rounded-2xl p-4 sm:p-6 max-w-4xl w-full text-sm relative" style="max-height:85vh; overflow:auto;">
          <div class="absolute top-3 left-3 flex gap-2">
            <button id="imgAuditExport" class="chip px-3 py-2 rounded-lg">Exportar cambios</button>
            <button id="imgAuditReset" class="chip px-3 py-2 rounded-lg">Reset</button>
          </div>
          <button id="imgAuditClose" class="ms360-ibtn absolute top-3 right-3">✕</button>
          <h2 class="text-lg font-extrabold mb-3">Revisor de imágenes</h2>
          <p class="text-white/70 mb-4">Corrige URLs que no coinciden con el producto. Los cambios se guardan en <strong>este navegador</strong>. Exporta para hacerlos permanentes.</p>

          <div class="grid gap-4">
            <section>
              <h3 class="font-bold mb-2">Posibles duplicados</h3>
              ${renderDupeTable(dupes)}
            </section>

            <section>
              <h3 class="font-bold mb-2">Sospechosos por título/categoría</h3>
              ${renderSuspectTable(suspects)}
            </section>
          </div>
        </div>
      `;
      document.body.appendChild(wrap); lockScroll();

      wrap.querySelector('#imgAuditClose').onclick = ()=>{ wrap.remove(); unlockScroll(); };
      bindAuditActions(); bindExportActions();
    }

    function bindExportActions(){
      const btnExport = document.getElementById('imgAuditExport');
      const btnReset  = document.getElementById('imgAuditReset');
      btnExport.onclick = ()=>{
        const data = JSON.stringify(getOverrides(), null, 2);
        const blob = new Blob([data], {type:'application/json'});
        const url  = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'image_overrides.json';
        document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        alert('Descargado: image_overrides.json. Sube estos cambios a tu products.json para que se vean en incógnito.');
      };
      btnReset.onclick = ()=>{
        localStorage.removeItem(LS_OVERRIDES);
        products = loadLocal(); products = applyImageOverrides(products); applyFilters();
        alert('Correcciones locales borradas en este navegador.');
      };
    }

    function findDuplicateImages(list){
      const map = {};
      list.forEach(p=>{
        const key = (p.image||'').trim(); if(!key) return;
        map[key] = map[key] || []; map[key].push(p);
      });
      return Object.values(map).filter(arr => arr.length > 1);
    }
    function findSuspects(list){
      const out = [];
      list.forEach(p=>{
        const img = (p.image||'').toLowerCase();
        const title = (p.title||'').toLowerCase();
        const fromAmazon = /m\.media-amazon\.com|images-na\.ssl-images-amazon\.com/.test(img);
        const hotwheels = title.includes('hot wheels') && !/hot|wheel|supra|toyota/.test(img);
        const beauty = p.category==='Belleza' && /tool|trimmer|clipper/i.test(img);
        if (!fromAmazon || hotwheels || beauty) out.push(p);
      });
      return out;
    }
    function renderDupeTable(groups){
      if(!groups.length) return `<div class="text-white/60">Sin duplicados. ✅</div>`;
      return groups.map(g=>{
        const rows = g.map(p=>`
          <tr data-id="${p.id}">
            <td class="align-top p-2 w-[72px]"><img src="${p.image}" alt="" class="w-16 h-16 object-contain bg-soft rounded-md"/></td>
            <td class="align-top p-2">
              <div class="font-semibold">${p.title}</div>
              <div class="text-white/60 text-xs">${p.id}</div>
              <div class="mt-1"><input class="input w-full" placeholder="Pega URL de imagen correcta" value="${p.image}" data-edit="${p.id}" /></div>
            </td>
            <td class="align-top p-2 w-[140px]"><button class="btn-neon rounded-lg px-3 py-2 w-full" data-save="${p.id}">Guardar</button></td>
          </tr>
        `).join('');
        return `
          <div class="overflow-auto rounded-xl border border-white/10"><table class="w-full text-sm"><tbody>${rows}</tbody></table></div>
          ${g.length===2 ? `<div class="mt-2"><button class="chip px-3 py-2 rounded-lg" data-swap="${g[0].id},${g[1].id}">Intercambiar imágenes</button></div>` : ''}
        `;
      }).join('<div class="h-4"></div>');
    }
    function renderSuspectTable(list){
      if(!list.length) return `<div class="text-white/60">Sin sospechosos. ✅</div>`;
      const rows = list.map(p=>`
        <tr data-id="${p.id}">
          <td class="align-top p-2 w-[72px]"><img src="${p.image}" alt="" class="w-16 h-16 object-contain bg-soft rounded-md"/></td>
          <td class="align-top p-2">
            <div class="font-semibold">${p.title}</div>
            <div class="text-white/60 text-xs">${p.id} • ${p.category}</div>
            <div class="mt-1"><input class="input w-full" placeholder="Pega URL de imagen correcta" value="${p.image}" data-edit="${p.id}" /></div>
          </td>
          <td class="align-top p-2 w-[140px]"><button class="btn-neon rounded-lg px-3 py-2 w-full" data-save="${p.id}">Guardar</button></td>
        </tr>`).join('');
      return `<div class="overflow-auto rounded-xl border border-white/10"><table class="w-full text-sm"><tbody>${rows}</tbody></table></div>`;
    }
    function bindAuditActions(){
      document.querySelectorAll('[data-save]').forEach(btn=>{
        btn.onclick = ()=>{
          const id = btn.getAttribute('data-save');
          const input = document.querySelector(`[data-edit="${id}"]`);
          const url = (input?.value||'').trim();
          if(!url){ alert('Pon una URL de imagen válida'); return; }
          const ov = getOverrides(); ov[id] = ov[id] || {}; ov[id].image = url; setOverrides(ov);
          products = applyImageOverrides(products); applyFilters();
          btn.textContent = 'Guardado ✓'; setTimeout(()=> btn.textContent='Guardar', 1200);
        };
      });
      document.querySelectorAll('[data-swap]').forEach(btn=>{
        btn.onclick = ()=>{
          const [a,b] = btn.getAttribute('data-swap').split(',');
          const pa = products.find(x=>x.id===a), pb = products.find(x=>x.id===b);
          if(!pa||!pb) return;
          const ov = getOverrides();
          const imgA = (ov[a]?.image)||pa.image;
          const imgB = (ov[b]?.image)||pb.image;
          ov[a] = {...(ov[a]||{}), image: imgB};
          ov[b] = {...(ov[b]||{}), image: imgA};
          setOverrides(ov);
          products = applyImageOverrides(products); applyFilters();
          btn.textContent = 'Intercambiado ✓'; setTimeout(()=> btn.textContent='Intercambiar imágenes', 1200);
        };
      });
    }
    products = applyImageOverrides(products); applyFilters();
    window.addEventListener('ja_products_updated', ()=>{ products = applyImageOverrides(products); applyFilters(); });

    // ---- Botón “Arriba”
    (function(){
      const btn = document.createElement('button');
      btn.id='ms360-top'; btn.className='btn-neon rounded-full px-4 py-3 font-extrabold'; btn.textContent='↑ Arriba';
      btn.addEventListener('click', ()=> window.scrollTo({top:0, behavior:'smooth'}));
      document.addEventListener('DOMContentLoaded', ()=> document.body.appendChild(btn), {once:true});
      window.addEventListener('scroll', ()=> { btn.classList.toggle('ms360-show', (window.scrollY||0) > 380); }, {passive:true});
    })();

    // ---- Layout Tiles + estado admin
    (function(){
      const html = document.documentElement;
      function enableTiles(){ html.classList.add('ms360-tiles'); }
      if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', enableTiles, { once:true });
      else enableTiles();
      html.classList.toggle('is-admin', isAdmin);
    })();
  </script>

  <!-- PWA: REGISTRO SW con actualización automática -->
  <script>
    if ('serviceWorker' in navigator) {
      const SW_VERSION = 'v2025-10-08-b'; // <-- cambia cuando subas cambios grandes
      window.addEventListener('load', () => {
        const url = `sw.js?${SW_VERSION}`;
        navigator.serviceWorker.register(url).then(reg => {
          // Forzar que el SW nuevo tome control y recargue
          function promptUpdate(sw){
            if (!sw) return;
            sw.postMessage({ type:'SKIP_WAITING' });
          }
          if (reg.waiting) promptUpdate(reg.waiting);
          reg.addEventListener('updatefound', ()=>{
            const nw = reg.installing;
            nw && nw.addEventListener('statechange', ()=>{
              if (nw.state === 'installed' && navigator.serviceWorker.controller) promptUpdate(nw);
            });
          });
          let refreshing = false;
          navigator.serviceWorker.addEventListener('controllerchange', ()=>{
            if (refreshing) return; refreshing = true; window.location.reload();
          });
        }).catch(()=>{});
      });
    }
  </script>

</body>
</html>
